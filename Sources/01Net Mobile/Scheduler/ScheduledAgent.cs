//*******************************************************************************************************************************
// DEBUT DU FICHIER
//*******************************************************************************************************************************

//*******************************************************************************************************************************
// Nom           : ScheduledAgent.cs
// Auteur        : Nicolas Dagnas
// Description   : Implémentation de l'objet ScheduledAgent
// Créé le       : 19/03/2015
// Modifié le    : 11/08/2015
//*******************************************************************************************************************************

//-------------------------------------------------------------------------------------------------------------------------------
#region Using directives
//-------------------------------------------------------------------------------------------------------------------------------
using System;
using System.Net;
using System.Linq;
using System.Text;
using System.Windows;
using System.Diagnostics;
using System.Windows.Media;
using System.IO.IsolatedStorage;
using System.Collections.Generic;
//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
using Microsoft.Phone.Shell;
using Microsoft.Phone.Scheduler;
using Microsoft.Phone.Net.NetworkInformation;
//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
using Newtonsoft.Json.Linq;
//-------------------------------------------------------------------------------------------------------------------------------
#endregion
//-------------------------------------------------------------------------------------------------------------------------------

//*******************************************************************************************************************************
// Début du bloc "NextRadio.Scheduler"
//*******************************************************************************************************************************
namespace NextRadio.Scheduler
	{

	//   ####   ###   #   #  #####  ####   #   #  #      #####  #### 
	//  #      #   #  #   #  #      #   #  #   #  #      #      #   #
	//   ###   #      #####  ###    #   #  #   #  #      ###    #   #
	//      #  #   #  #   #  #      #   #  #   #  #      #      #   #
	//  ####    ###   #   #  #####  ####    ###   #####  #####  #### 

	//***************************************************************************************************************************
	// Classe ScheduledAgent
	//***************************************************************************************************************************
	#region // Déclaration et Implémentation de l'Objet
	//---------------------------------------------------------------------------------------------------------------------------
	/// <summary>
	/// Définit le comportement de l'agent.
	/// </summary>
	//---------------------------------------------------------------------------------------------------------------------------
	public class ScheduledAgent : ScheduledTaskAgent
		{
		//***********************************************************************************************************************
		#region // Objet FlipTileOptions
		//-----------------------------------------------------------------------------------------------------------------------
		private class FlipTileOptions
			{
			//*******************************************************************************************************************
			/// <summary>
			/// Obtiens la configuration de la tuile celon son type.
			/// </summary>
			/// <param name="Section"></param>
			/// <returns></returns>
			//-------------------------------------------------------------------------------------------------------------------
			public static FlipTileOptions FromTile ( ShellTile Tile )
				{
				//---------------------------------------------------------------------------------------------------------------
				return FlipTileOptions.FromUri ( Tile.NavigationUri );
				//---------------------------------------------------------------------------------------------------------------
				}
			//*******************************************************************************************************************

			//*******************************************************************************************************************
			/// <summary>
			/// Obtiens la configuration de la tuile celon son type.
			/// </summary>
			/// <param name="Section"></param>
			/// <returns></returns>
			//-------------------------------------------------------------------------------------------------------------------
			public static FlipTileOptions FromUri ( Uri Uri )
				{
				//---------------------------------------------------------------------------------------------------------------
				switch ( Uri.OriginalString )
					{
					//-----------------------------------------------------------------------------------------------------------
					#region // All
					//-----------------------------------------------------------------------------------------------------------
					case "/Frames/Frm_Home.xaml?Section=All" :
						{
						//-------------------------------------------------------------------------------------------------------
						return new FlipTileOptions ()
							{
							//---------------------------------------------------------------------------------------------------
							Title                   = string.Empty                         ,
							BackTitle               = "01Net Mobile"                       ,
							Uri                     = string.Empty                         ,
							SmallBackgroundImage    = "Assets/Tiles/All/FlipTileSmall.png" ,
							BackgroundImage         = "Assets/Tiles/All/FlipTileMedium.png",
							WideBackgroundImage     = "Assets/Tiles/All/FlipTileWide.png"  ,
							BackBackgroundImage     = "Assets/Tiles/All/BackTileMedium.png",
							WideBackBackgroundImage = "Assets/Tiles/All/BackTileWide.png"  ,
							//---------------------------------------------------------------------------------------------------
							};
						//-------------------------------------------------------------------------------------------------------
						}
					//-----------------------------------------------------------------------------------------------------------
					#endregion
					//-----------------------------------------------------------------------------------------------------------
					#region // Bookmarks
					//-----------------------------------------------------------------------------------------------------------
					case "/Frames/Frm_Home.xaml?Section=Bookmarks" :
						{
						//-------------------------------------------------------------------------------------------------------
						return new FlipTileOptions ()
							{
							//---------------------------------------------------------------------------------------------------
							Title                   = "Mes favoris"                              ,
							BackTitle               = "Mes favoris"                              ,
							Uri                     = string.Empty                               ,
							SmallBackgroundImage    = "Assets/Tiles/Bookmarks/FlipTileSmall.png" ,
							BackgroundImage         = "Assets/Tiles/Bookmarks/FlipTileMedium.png",
							WideBackgroundImage     = "Assets/Tiles/Bookmarks/FlipTileWide.png"  ,
							BackBackgroundImage     = "Assets/Tiles/Bookmarks/BackTileMedium.png",
							WideBackBackgroundImage = "Assets/Tiles/Bookmarks/BackTileWide.png"  ,
							//---------------------------------------------------------------------------------------------------
							};
						//-------------------------------------------------------------------------------------------------------
						}
					//-----------------------------------------------------------------------------------------------------------
					#endregion
					//-----------------------------------------------------------------------------------------------------------

					//-----------------------------------------------------------------------------------------------------------
					#region // Apps
					//-----------------------------------------------------------------------------------------------------------
					case "/Frames/Frm_Home.xaml?Section=Apps" :
						{
						//-------------------------------------------------------------------------------------------------------
						return new FlipTileOptions ()
							{
							//---------------------------------------------------------------------------------------------------
							Title                   = "Appli, logiciels"                                ,
							BackTitle               = "Appli, logiciels"                                ,
							Uri                     = "getArticlesList?category=4131345&count=40&page=1",
							SmallBackgroundImage    = "Assets/Tiles/Apps/FlipTileSmall.png"             ,
							BackgroundImage         = "Assets/Tiles/Apps/FlipTileMedium.png"            ,
							WideBackgroundImage     = "Assets/Tiles/Apps/FlipTileWide.png"              ,
							BackBackgroundImage     = "Assets/Tiles/Apps/BackTileMedium.png"            ,
							WideBackBackgroundImage = "Assets/Tiles/Apps/BackTileWide.png"              ,
							//---------------------------------------------------------------------------------------------------
							};
						//-------------------------------------------------------------------------------------------------------
						}
					//-----------------------------------------------------------------------------------------------------------
					#endregion
					//-----------------------------------------------------------------------------------------------------------
					#region // Culture
					//-----------------------------------------------------------------------------------------------------------
					case "/Frames/Frm_Home.xaml?Section=Culture" :
						{
						//-------------------------------------------------------------------------------------------------------
						return new FlipTileOptions ()
							{
							//---------------------------------------------------------------------------------------------------
							Title                   = "Culture, Medias"                                 ,
							BackTitle               = "Culture, Medias"                                 ,
							Uri                     = "getArticlesList?category=4131365&count=40&page=1",
							SmallBackgroundImage    = "Assets/Tiles/Culture/FlipTileSmall.png"          ,
							BackgroundImage         = "Assets/Tiles/Culture/FlipTileMedium.png"         ,
							WideBackgroundImage     = "Assets/Tiles/Culture/FlipTileWide.png"           ,
							BackBackgroundImage     = "Assets/Tiles/Culture/BackTileMedium.png"         ,
							WideBackBackgroundImage = "Assets/Tiles/Culture/BackTileWide.png"           ,
							//---------------------------------------------------------------------------------------------------
							};
						//-------------------------------------------------------------------------------------------------------
						}
					//-----------------------------------------------------------------------------------------------------------
					#endregion
					//-----------------------------------------------------------------------------------------------------------
					#region // Games
					//-----------------------------------------------------------------------------------------------------------
					case "/Frames/Frm_Home.xaml?Section=Games" :
						{
						//-------------------------------------------------------------------------------------------------------
						return new FlipTileOptions ()
							{
							//---------------------------------------------------------------------------------------------------
							Title                   = "Jeux"                                            ,
							BackTitle               = "Jeux"                                            ,
							Uri                     = "getArticlesList?category=4131368&count=40&page=1",
							SmallBackgroundImage    = "Assets/Tiles/Games/FlipTileSmall.png"            ,
							BackgroundImage         = "Assets/Tiles/Games/FlipTileMedium.png"           ,
							WideBackgroundImage     = "Assets/Tiles/Games/FlipTileWide.png"             ,
							BackBackgroundImage     = "Assets/Tiles/Games/BackTileMedium.png"           ,
							WideBackBackgroundImage = "Assets/Tiles/Games/BackTileWide.png"             ,
							//---------------------------------------------------------------------------------------------------
							};
						//-------------------------------------------------------------------------------------------------------
						}
					//-----------------------------------------------------------------------------------------------------------
					#endregion
					//-----------------------------------------------------------------------------------------------------------
					#region // Politics
					//-----------------------------------------------------------------------------------------------------------
					case "/Frames/Frm_Home.xaml?Section=Politics" :
						{
						//-------------------------------------------------------------------------------------------------------
						return new FlipTileOptions ()
							{
							//---------------------------------------------------------------------------------------------------
							Title                   = "Politique, Droits"                               ,
							BackTitle               = "Politique, Droits"                               ,
							Uri                     = "getArticlesList?category=4131409&count=40&page=1",
							SmallBackgroundImage    = "Assets/Tiles/Politics/FlipTileSmall.png"         ,
							BackgroundImage         = "Assets/Tiles/Politics/FlipTileMedium.png"        ,
							WideBackgroundImage     = "Assets/Tiles/Politics/FlipTileWide.png"          ,
							BackBackgroundImage     = "Assets/Tiles/Politics/BackTileMedium.png"        ,
							WideBackBackgroundImage = "Assets/Tiles/Politics/BackTileWide.png"          ,
							//---------------------------------------------------------------------------------------------------
							};
						//-------------------------------------------------------------------------------------------------------
						}
					//-----------------------------------------------------------------------------------------------------------
					#endregion
					//-----------------------------------------------------------------------------------------------------------
					#region // Products
					//-----------------------------------------------------------------------------------------------------------
					case "/Frames/Frm_Home.xaml?Section=Products" :
						{
						//-------------------------------------------------------------------------------------------------------
						return new FlipTileOptions ()
							{
							//---------------------------------------------------------------------------------------------------
							Title                   = "Produits"                                        ,
							BackTitle               = "Produits"                                        ,
							Uri                     = "getArticlesList?category=4131350&count=40&page=1",
							SmallBackgroundImage    = "Assets/Tiles/Products/FlipTileSmall.png"         ,
							BackgroundImage         = "Assets/Tiles/Products/FlipTileMedium.png"        ,
							WideBackgroundImage     = "Assets/Tiles/Products/FlipTileWide.png"          ,
							BackBackgroundImage     = "Assets/Tiles/Products/BackTileMedium.png"        ,
							WideBackBackgroundImage = "Assets/Tiles/Products/BackTileWide.png"          ,
							//---------------------------------------------------------------------------------------------------
							};
						//-------------------------------------------------------------------------------------------------------
						}
					//-----------------------------------------------------------------------------------------------------------
					#endregion
					//-----------------------------------------------------------------------------------------------------------
					#region // Rugby
					//-----------------------------------------------------------------------------------------------------------
					case "/Frames/Frm_Home.xaml?Section=Rugby" :
						{
						//-------------------------------------------------------------------------------------------------------
						return new FlipTileOptions ()
							{
							//---------------------------------------------------------------------------------------------------
							Title                   = "Rugby"                                      ,
							BackTitle               = "Rugby"                                      ,
							Uri                    = "getArticlesList?category=345&count=40&page=1",
							SmallBackgroundImage    = "Assets/Tiles/Rugby/FlipTileSmall.png"       ,
							BackgroundImage         = "Assets/Tiles/Rugby/FlipTileMedium.png"      ,
							WideBackgroundImage     = "Assets/Tiles/Rugby/FlipTileWide.png"        ,
							BackBackgroundImage     = "Assets/Tiles/Rugby/BackTileMedium.png"      ,
							WideBackBackgroundImage = "Assets/Tiles/Rugby/BackTileWide.png"        ,
							//---------------------------------------------------------------------------------------------------
							};
						//-------------------------------------------------------------------------------------------------------
						}
					//-----------------------------------------------------------------------------------------------------------
					#endregion
					//-----------------------------------------------------------------------------------------------------------
					#region // Security
					//-----------------------------------------------------------------------------------------------------------
					case "/Frames/Frm_Home.xaml?Section=Security" :
						{
						//-------------------------------------------------------------------------------------------------------
						return new FlipTileOptions ()
							{
							//---------------------------------------------------------------------------------------------------
							Title                   = "Sécurité"                                        ,
							BackTitle               = "Sécurité"                                        ,
							Uri                     = "getArticlesList?category=4131359&count=40&page=1",
							SmallBackgroundImage    = "Assets/Tiles/Security/FlipTileSmall.png"         ,
							BackgroundImage         = "Assets/Tiles/Security/FlipTileMedium.png"        ,
							WideBackgroundImage     = "Assets/Tiles/Security/FlipTileWide.png"          ,
							BackBackgroundImage     = "Assets/Tiles/Security/BackTileMedium.png"        ,
							WideBackBackgroundImage = "Assets/Tiles/Security/BackTileWide.png"          ,
							//---------------------------------------------------------------------------------------------------
							};
						//-------------------------------------------------------------------------------------------------------
						}
					//-----------------------------------------------------------------------------------------------------------
					#endregion
					//-----------------------------------------------------------------------------------------------------------
					#region // Science
					//-----------------------------------------------------------------------------------------------------------
					case "/Frames/Frm_Home.xaml?Section=Science" :
						{
						//-------------------------------------------------------------------------------------------------------
						return new FlipTileOptions ()
							{
							//---------------------------------------------------------------------------------------------------
							Title                   = "Science"                                         ,
							BackTitle               = "Science"                                         ,
							Uri                     = "getArticlesList?category=4131377&count=40&page=1",
							SmallBackgroundImage    = "Assets/Tiles/Science/FlipTileSmall.png"          ,
							BackgroundImage         = "Assets/Tiles/Science/FlipTileMedium.png"         ,
							WideBackgroundImage     = "Assets/Tiles/Science/FlipTileWide.png"           ,
							BackBackgroundImage     = "Assets/Tiles/Science/BackTileMedium.png"         ,
							WideBackBackgroundImage = "Assets/Tiles/Science/BackTileWide.png"           ,
							//---------------------------------------------------------------------------------------------------
							};
						//-------------------------------------------------------------------------------------------------------
						}
					//-----------------------------------------------------------------------------------------------------------
					#endregion
					//-----------------------------------------------------------------------------------------------------------
					#region // Society
					//-----------------------------------------------------------------------------------------------------------
					case "/Frames/Frm_Home.xaml?Section=Society" :
						{
						//-------------------------------------------------------------------------------------------------------
						return new FlipTileOptions ()
							{
							//---------------------------------------------------------------------------------------------------
							Title                   = "Buzz, Société"                                  ,
							BackTitle               = "Buzz, Société"                                  ,
							Uri                    = "getArticlesList?category=4131397&count=40&page=1",
							SmallBackgroundImage    = "Assets/Tiles/Society/FlipTileSmall.png"         ,
							BackgroundImage         = "Assets/Tiles/Society/FlipTileMedium.png"        ,
							WideBackgroundImage     = "Assets/Tiles/Society/FlipTileWide.png"          ,
							BackBackgroundImage     = "Assets/Tiles/Society/BackTileMedium.png"        ,
							WideBackBackgroundImage = "Assets/Tiles/Society/BackTileWide.png"          ,
							//---------------------------------------------------------------------------------------------------
							};
						//-------------------------------------------------------------------------------------------------------
						}
					//-----------------------------------------------------------------------------------------------------------
					#endregion
					//-----------------------------------------------------------------------------------------------------------
					#region // Technology
					//-----------------------------------------------------------------------------------------------------------
					case "/Frames/Frm_Home.xaml?Section=Technology" :
						{
						//-------------------------------------------------------------------------------------------------------
						return new FlipTileOptions ()
							{
							//---------------------------------------------------------------------------------------------------
							Title                   = "Technologies"                                    ,
							BackTitle               = "Technologies"                                    ,
							Uri                     = "getArticlesList?category=4131401&count=40&page=1",
							SmallBackgroundImage    = "Assets/Tiles/Technology/FlipTileSmall.png"       ,
							BackgroundImage         = "Assets/Tiles/Technology/FlipTileMedium.png"      ,
							WideBackgroundImage     = "Assets/Tiles/Technology/FlipTileWide.png"        ,
							BackBackgroundImage     = "Assets/Tiles/Technology/BackTileMedium.png"      ,
							WideBackBackgroundImage = "Assets/Tiles/Technology/BackTileWide.png"        ,
							//---------------------------------------------------------------------------------------------------
							};
						//-------------------------------------------------------------------------------------------------------
						}
					//-----------------------------------------------------------------------------------------------------------
					#endregion
					//-----------------------------------------------------------------------------------------------------------
					#region // Telecoms
					//-----------------------------------------------------------------------------------------------------------
					case "/Frames/Frm_Home.xaml?Section=Telecoms" :
						{
						//-------------------------------------------------------------------------------------------------------
						return new FlipTileOptions ()
							{
							//---------------------------------------------------------------------------------------------------
							Title                   = "Télécoms"                                        ,
							BackTitle               = "Télécoms"                                        ,
							Uri                     = "getArticlesList?category=4131357&count=40&page=1",
							SmallBackgroundImage    = "Assets/Tiles/Telecoms/FlipTileSmall.png"         ,
							BackgroundImage         = "Assets/Tiles/Telecoms/FlipTileMedium.png"        ,
							WideBackgroundImage     = "Assets/Tiles/Telecoms/FlipTileWide.png"          ,
							BackBackgroundImage     = "Assets/Tiles/Telecoms/BackTileMedium.png"        ,
							WideBackBackgroundImage = "Assets/Tiles/Telecoms/BackTileWide.png"          ,
							//---------------------------------------------------------------------------------------------------
							};
						//-------------------------------------------------------------------------------------------------------
						}
					//-----------------------------------------------------------------------------------------------------------
					#endregion
					//-----------------------------------------------------------------------------------------------------------
					#region // Tv
					//-----------------------------------------------------------------------------------------------------------
					case "/Frames/Frm_Home.xaml?Section=Tv" :
						{
						//-------------------------------------------------------------------------------------------------------
						return new FlipTileOptions ()
							{
							//---------------------------------------------------------------------------------------------------
							Title                   = "01Net Tv"                          ,
							BackTitle               = "01Net Tv"                          ,
							Uri                     = "getLastVideosList?count=40&page=1" ,
							SmallBackgroundImage    = "Assets/Tiles/Tv/FlipTileSmall.png" ,
							BackgroundImage         = "Assets/Tiles/Tv/FlipTileMedium.png",
							WideBackgroundImage     = "Assets/Tiles/Tv/FlipTileWide.png"  ,
							BackBackgroundImage     = "Assets/Tiles/Tv/BackTileMedium.png",
							WideBackBackgroundImage = "Assets/Tiles/Tv/BackTileWide.png"  ,
							//---------------------------------------------------------------------------------------------------
							};
						//-------------------------------------------------------------------------------------------------------
						}
					//-----------------------------------------------------------------------------------------------------------
					#endregion
					//-----------------------------------------------------------------------------------------------------------
					}
				//---------------------------------------------------------------------------------------------------------------
				
				//---------------------------------------------------------------------------------------------------------------
				return new FlipTileOptions ()
					{
					//-----------------------------------------------------------------------------------------------------------
					Title                   = string.Empty                     ,
					BackTitle               = string.Empty                     ,
					Uri                     = string.Empty                     ,
					SmallBackgroundImage    = "Assets/Tiles/FlipTileSmall.png" ,
					BackgroundImage         = "Assets/Tiles/FlipTileMedium.png",
					WideBackgroundImage     = "Assets/Tiles/FlipTileWide.png"  ,
					BackBackgroundImage     = "Assets/Tiles/BackTileMedium.png",
					WideBackBackgroundImage = "Assets/Tiles/BackTileWide.png"  ,
					//-----------------------------------------------------------------------------------------------------------
					};
				//---------------------------------------------------------------------------------------------------------------
				}
			//*******************************************************************************************************************

			//-------------------------------------------------------------------------------------------------------------------
			public string Title                   { get; private set; }
			public string BackTitle               { get; private set; }
			public string Uri                     { get; private set; }
			public string SmallBackgroundImage    { get; private set; }
			public string BackgroundImage         { get; private set; }
			public string WideBackgroundImage     { get; private set; }
			public string BackBackgroundImage     { get; private set; }
			public string WideBackBackgroundImage { get; private set; }
			//-------------------------------------------------------------------------------------------------------------------
			}
		//-----------------------------------------------------------------------------------------------------------------------
		#endregion
		//***********************************************************************************************************************
		
		//***********************************************************************************************************************
		#region // Structure FlipTileInfos
		//-----------------------------------------------------------------------------------------------------------------------
		struct FlipTileInfos
			{
			//-------------------------------------------------------------------------------------------------------------------
			public string   ArticleID   { get; set; }
			public string   Title       { get; set; }
			public DateTime PublishDate { get; set; }
			public string   Link        { get; set; }
			public bool     IsVideo     { get; set; }
			public string   Uri         { get; set; }
			//-------------------------------------------------------------------------------------------------------------------
			}
		//-----------------------------------------------------------------------------------------------------------------------
		#endregion
		//***********************************************************************************************************************

		//***********************************************************************************************************************
		#region // Classe DownloadDataState
		//-----------------------------------------------------------------------------------------------------------------------
		class DownloadDataState
			{
			//-------------------------------------------------------------------------------------------------------------------
			// Section des Attributs
			//-------------------------------------------------------------------------------------------------------------------
			private string                            Token    = string.Empty;
			private List      <string>                UriList  = null;
			private Dictionary<string, FlipTileInfos> Articles = null;
			//-------------------------------------------------------------------------------------------------------------------

			//*******************************************************************************************************************
			/// <summary>
			/// 
			/// </summary>
			//-------------------------------------------------------------------------------------------------------------------
			public DownloadDataState ()
				{
				//---------------------------------------------------------------------------------------------------------------
				Items    = new List      <        FlipTileInfos> ();
				UriList  = new List      <string               > ();
				Articles = new Dictionary<string, FlipTileInfos> ();

				this.LastAppLaunch  = StorageSettings.GetValue ( "agent-last-app-launch" , DateTime.MinValue );
				this.LastToastCheck = StorageSettings.GetValue ( "agent-last-toast-check", DateTime.MinValue );

				this.CheckToast = ( ScheduledAgent.ToastDelay > 0 && DateTime.Now.Subtract 
				                       ( LastToastCheck ).TotalHours > ScheduledAgent.ToastDelay );
				//---------------------------------------------------------------------------------------------------------------

				//---------------------------------------------------------------------------------------------------------------
				this.UriList.Add ( "getLastArticles?count=40&page=1" );

				if ( ScheduledAgent.TileIsActive )
					{
					foreach ( ShellTile Tile in ShellTile.ActiveTiles )
						{
						var Infos = FlipTileOptions.FromTile ( Tile );

						if ( ! string.IsNullOrEmpty ( Infos.Uri ) )
							if ( ! this.UriList.Contains ( Infos.Uri ) )
								this.UriList.Add ( Infos.Uri );
						}
					}
				//---------------------------------------------------------------------------------------------------------------
				}
			//*******************************************************************************************************************
			
			//-------------------------------------------------------------------------------------------------------------------
			public bool                CheckToast     { get; private set; }
			public DateTime            LastAppLaunch  { get; private set; }
			public DateTime            LastToastCheck { get; private set; }
			public List<FlipTileInfos> Items          { get; private set; }
			//-------------------------------------------------------------------------------------------------------------------
			
			//*******************************************************************************************************************
			/// <summary>
			/// 
			/// </summary>
			//-------------------------------------------------------------------------------------------------------------------
			public string BaseUri
				{
				//---------------------------------------------------------------------------------------------------------------
				get
					{
					//-----------------------------------------------------------------------------------------------------------
					return "https://api.nextradiotv.com/01net-iphone/3/" + 
					                     ( ( string.IsNullOrEmpty ( Token ) ) ? "" : Token + "/" );
					//-----------------------------------------------------------------------------------------------------------
					}
				//---------------------------------------------------------------------------------------------------------------
				}
			//*******************************************************************************************************************
			
			//*******************************************************************************************************************
			/// <summary>
			/// 
			/// </summary>
			//-------------------------------------------------------------------------------------------------------------------
			public Uri Uri
				{
				//---------------------------------------------------------------------------------------------------------------
				get
					{
					//-----------------------------------------------------------------------------------------------------------
					return ( UriList.Count == 0 ) ? null : new Uri ( BaseUri + this.UriList[0] );
					//-----------------------------------------------------------------------------------------------------------
					}
				//---------------------------------------------------------------------------------------------------------------
				}
			//*******************************************************************************************************************
			
			//*******************************************************************************************************************
			/// <summary>
			/// Définit le Token
			/// </summary>
			//-------------------------------------------------------------------------------------------------------------------
			public void AddUnique ( FlipTileInfos Item )
				{
				//---------------------------------------------------------------------------------------------------------------
				if ( ! this.Articles.ContainsKey ( Item.ArticleID ) )
					{
					//-----------------------------------------------------------------------------------------------------------
					if ( ! string.IsNullOrEmpty ( Item.Uri ) )
						Item.Uri = Item.Uri.Substring ( this.BaseUri.Length );
					
					this.Items.Add ( Item );

					this.Articles[Item.ArticleID] = Item;
					//-----------------------------------------------------------------------------------------------------------
					}
				//---------------------------------------------------------------------------------------------------------------

				//---------------------------------------------------------------------------------------------------------------
				else
					{
					//-----------------------------------------------------------------------------------------------------------
					FlipTileInfos PrevItem = this.Articles[Item.ArticleID];

					if ( ! string.IsNullOrEmpty ( Item.Uri ) )
						Item.Uri = Item.Uri.Substring ( this.BaseUri.Length );
					
					PrevItem.Uri += ( ";" + Item.Uri );
					//-----------------------------------------------------------------------------------------------------------
					}
				//---------------------------------------------------------------------------------------------------------------
				}
			//*******************************************************************************************************************

			//*******************************************************************************************************************
			/// <summary>
			/// Définit le Token
			/// </summary>
			//-------------------------------------------------------------------------------------------------------------------
			public void SetToken ( string Token ) { this.Token = Token; }
			//*******************************************************************************************************************

			//*******************************************************************************************************************
			/// <summary>
			/// Obtiens la prochaine Uri à traiter.
			/// </summary>
			//-------------------------------------------------------------------------------------------------------------------
			public void Notify ()
				{
				//---------------------------------------------------------------------------------------------------------------
				if ( this.UriList.Count > 0 ) this.UriList.RemoveAt ( 0 );
				//---------------------------------------------------------------------------------------------------------------
				}
			//*******************************************************************************************************************

			//*******************************************************************************************************************
			/// <summary>
			/// Prévient que le processus est finit.
			/// </summary>
			//-------------------------------------------------------------------------------------------------------------------
			public void ToastNotify ()
				{
				//---------------------------------------------------------------------------------------------------------------
				StorageSettings.SetValue ( "agent-last-toast-check", DateTime.Now );
				//---------------------------------------------------------------------------------------------------------------
				}
			//*******************************************************************************************************************
			}
		//-----------------------------------------------------------------------------------------------------------------------
		#endregion
		//***********************************************************************************************************************

		//***********************************************************************************************************************
		#region // Classe FlipTileInfosComparer
		//-----------------------------------------------------------------------------------------------------------------------
		class FlipTileInfosComparer : IComparer<FlipTileInfos>
			{
			//-------------------------------------------------------------------------------------------------------------------
			public int Compare ( FlipTileInfos X, FlipTileInfos Y )
				{ return ( X.PublishDate > Y.PublishDate ) ? -1 : 1; }
			//-------------------------------------------------------------------------------------------------------------------
			}
		//-----------------------------------------------------------------------------------------------------------------------
		#endregion
		//***********************************************************************************************************************

		//-----------------------------------------------------------------------------------------------------------------------
		// Section des Constantes
		//-----------------------------------------------------------------------------------------------------------------------
		private const string UserAgent = "01net 3.3.1 (iPad; iPhone OS 9.2; fr_FR)";
		//-----------------------------------------------------------------------------------------------------------------------

		//***********************************************************************************************************************
		#region // Section du Constructeur
		//-----------------------------------------------------------------------------------------------------------------------

		//***********************************************************************************************************************
		/// <remarks>
		/// Le constructeur ScheduledAgent initialise le gestionnaire UnhandledException.
		/// </remarks>
		//-----------------------------------------------------------------------------------------------------------------------
		static ScheduledAgent ()
			{
			//-------------------------------------------------------------------------------------------------------------------
			Deployment.Current.Dispatcher.BeginInvoke ( delegate 
			                   { Application.Current.UnhandledException += UnhandledException; } );
			//-------------------------------------------------------------------------------------------------------------------
			}
		//***********************************************************************************************************************

		//***********************************************************************************************************************
		/// <summary>
		/// Se produit quand une exception est générée.
		/// </summary>
		/// <param name="Sender">Objet source de l'appel.</param>
		/// <param name="Args">
		/// <b>ApplicationUnhandledExceptionEventArgs</b> qui contient les données d'événement.
		/// </param>
		//-----------------------------------------------------------------------------------------------------------------------
		private static void UnhandledException ( object Sender, ApplicationUnhandledExceptionEventArgs Args )
			{
			//-------------------------------------------------------------------------------------------------------------------
			Args.Handled = true;
			//-------------------------------------------------------------------------------------------------------------------
			}
		//***********************************************************************************************************************

		//-----------------------------------------------------------------------------------------------------------------------
		#endregion
		//***********************************************************************************************************************
		
		//***********************************************************************************************************************
		#region // Section des Procédures Privées
		//-----------------------------------------------------------------------------------------------------------------------
		
		//***********************************************************************************************************************
		/// <summary>
		/// Découpe la chaine en plusieurs chaines plus petites
		/// </summary>
		/// <param name="Value">Chaine à découper.</param>
		/// <returns>Chaine découpée.</returns>
		//-----------------------------------------------------------------------------------------------------------------------
		private static string WordWrap ( string Value, int Size, int MaxLines )
			{
			//-------------------------------------------------------------------------------------------------------------------
			int LastWhiteSpace = -1;
			var Buffer         = new StringBuilder ();
			var Result         = new StringBuilder ();
			//-------------------------------------------------------------------------------------------------------------------

			//-------------------------------------------------------------------------------------------------------------------
			for ( int Index = 0 ; Index < Value.Length && MaxLines > 0 ; Index ++ )
				{
				//---------------------------------------------------------------------------------------------------------------
				char Car = Value[Index];

				if ( Char.IsWhiteSpace ( Car ) ) LastWhiteSpace = Index;

				Buffer.Append ( Car );
				//---------------------------------------------------------------------------------------------------------------

				//---------------------------------------------------------------------------------------------------------------
				if ( Buffer.Length >= Size && LastWhiteSpace > -1 )
					{
					//-----------------------------------------------------------------------------------------------------------
					if ( MaxLines > 0 )
						{
						//-------------------------------------------------------------------------------------------------------
						Result.Append ( Buffer.ToString ( 0, LastWhiteSpace ) );

						if ( MaxLines > 1 )
							{
							Result.Append ( "&#13;" );
							}
						else
							{
							if ( Index == Value.Length ) Result.Append ( "."     );
							else                         Result.Append ( " ..."  );
							}

						Buffer = new System.Text.StringBuilder ();

						Index  = -1;
						MaxLines --;

						Value = Value.Substring ( LastWhiteSpace + 1 );
						//-------------------------------------------------------------------------------------------------------
						}
					//-----------------------------------------------------------------------------------------------------------
					}
				}
			//-------------------------------------------------------------------------------------------------------------------

			//-------------------------------------------------------------------------------------------------------------------
			if ( Buffer.Length > 0 && MaxLines > 0 ) Result.Append ( Buffer.ToString () );

			string FinalResult = Result.ToString ();

			if ( ! FinalResult.EndsWith ( "." ) ) FinalResult += ".";

			return FinalResult;
			//-------------------------------------------------------------------------------------------------------------------
			}
		//***********************************************************************************************************************

		//-----------------------------------------------------------------------------------------------------------------------
		#endregion
		//***********************************************************************************************************************

		//***********************************************************************************************************************
		#region // Section de Gestion de la Tuile
		//-----------------------------------------------------------------------------------------------------------------------

		//***********************************************************************************************************************
		/// <summary>
		/// Gère l'affichage final de la tuile.
		/// </summary>
		/// <param name="Tile">Tuile à mettre à jour.</param>
		/// <param name="Images">Configuration de la tuile.</param>
		/// <param name="Content">Texte à afficher.</param>
		//-----------------------------------------------------------------------------------------------------------------------
		private static FlipTileData GetTileData ( FlipTileOptions Config, string Content )
			{
			//-------------------------------------------------------------------------------------------------------------------
			string XmlContent = String.Empty;
			//-------------------------------------------------------------------------------------------------------------------
				
			//-------------------------------------------------------------------------------------------------------------------
			string TitleClear     = ( string.IsNullOrEmpty ( Config.Title     ) ) ? "Action=\"Clear\"" : "";
			string BackTitleClear = ( string.IsNullOrEmpty ( Config.BackTitle ) ) ? "Action=\"Clear\"" : "";
			//-------------------------------------------------------------------------------------------------------------------

			//-------------------------------------------------------------------------------------------------------------------
			// Tuile avec article
			//-------------------------------------------------------------------------------------------------------------------
			if ( string.IsNullOrEmpty ( Content ) )
				{
				//---------------------------------------------------------------------------------------------------------------
				#region // Déclaration du corp
				//---------------------------------------------------------------------------------------------------------------
				XmlContent = "<?xml version=\"1.0\" encoding=\"utf-8\"?>\n"                                   +
					         "<wp:Notification xmlns:wp=\"WPNotification\" Version=\"2.0\">\n"                +
					         " <wp:Tile Id=\"1\" Template=\"FlipTile\">\n"                                    +
					         "  <wp:Count>0</wp:Count>\n"                                                     +
					         "  <wp:Title {0}>{1}</wp:Title>\n"                                               +
					         "  <wp:SmallBackgroundImage IsRelative=\"true\">{2}</wp:SmallBackgroundImage>\n" +
					         "  <wp:BackgroundImage IsRelative=\"true\">{3}</wp:BackgroundImage>\n"           +
					         "  <wp:WideBackgroundImage IsRelative=\"true\">{4}</wp:WideBackgroundImage>\n"   +
					         "  <wp:BackTitle Action=\"Clear\" />\n"                                          +
					         "  <wp:BackContent Action=\"Clear\" />\n"                                        +
					         "  <wp:WideBackContent Action=\"Clear\" />\n"                                    +
					         "  <wp:BackBackgroundImage IsRelative=\"true\" Action=\"Clear\" />\n"            +
					         "  <wp:WideBackBackgroundImage IsRelative=\"true\" Action=\"Clear\" />\n"        +
					         " </wp:Tile>\n"                                                                  +
					         "</wp:Notification>";

				XmlContent = string.Format ( XmlContent, TitleClear                 , 
					                                     Config.Title               , 
					                                     Config.SmallBackgroundImage, 
					                                     Config.BackgroundImage     , 
					                                     Config.WideBackgroundImage );
				//---------------------------------------------------------------------------------------------------------------
				#endregion
				//---------------------------------------------------------------------------------------------------------------
				}
			//-------------------------------------------------------------------------------------------------------------------

			//-------------------------------------------------------------------------------------------------------------------
			// Tuile sans article
			//-------------------------------------------------------------------------------------------------------------------
			else
				{
				//---------------------------------------------------------------------------------------------------------------
				#region // Déclaration du corp
				//---------------------------------------------------------------------------------------------------------------
				XmlContent = "<?xml version=\"1.0\" encoding=\"utf-8\"?>\n"                                          +
					         "<wp:Notification xmlns:wp=\"WPNotification\" Version=\"2.0\">\n"                       +
					         " <wp:Tile Id=\"1\" Template=\"FlipTile\">\n"                                           +
					         "  <wp:Count>0</wp:Count>\n"                                                            +
					         "  <wp:Title {0}>{1}</wp:Title>\n"                                                      +
					         "  <wp:SmallBackgroundImage IsRelative=\"true\">{2}</wp:SmallBackgroundImage>\n"        +
					         "  <wp:BackgroundImage IsRelative=\"true\">{3}</wp:BackgroundImage>\n"                  +
					         "  <wp:WideBackgroundImage IsRelative=\"true\">{4}</wp:WideBackgroundImage>\n"          +
					         "  <wp:BackTitle {5}>{6}</wp:BackTitle>\n"                                              +
					         "  <wp:BackContent>{7}</wp:BackContent>\n"                                              +
					         "  <wp:WideBackContent>{8}</wp:WideBackContent>\n"                                      +
					         "  <wp:BackBackgroundImage IsRelative=\"true\">{9}</wp:BackBackgroundImage>\n"          +
					         "  <wp:WideBackBackgroundImage IsRelative=\"true\">{10}</wp:WideBackBackgroundImage>\n" +
					         " </wp:Tile>\n" +
					         "</wp:Notification>";
					
				XmlContent = string.Format ( XmlContent, TitleClear                     , 
					                                     Config.Title                   , 
					                                     Config.SmallBackgroundImage    , 
					                                     Config.BackgroundImage         , 
					                                     Config.WideBackgroundImage     ,
					                                     BackTitleClear                 , 
					                                     Config.BackTitle               , 
					                                     Content                        , 
					                                     WordWrap ( Content, 26, 3 )    ,
					                                     Config.BackBackgroundImage     ,
					                                     Config.WideBackBackgroundImage );
				//---------------------------------------------------------------------------------------------------------------
				#endregion
				//---------------------------------------------------------------------------------------------------------------
				}
			//-------------------------------------------------------------------------------------------------------------------

			//-------------------------------------------------------------------------------------------------------------------
			return new FlipTileData ( XmlContent );
			//-------------------------------------------------------------------------------------------------------------------
			}
		//***********************************************************************************************************************

		//***********************************************************************************************************************
		/// <summary>
		/// Purge la tuile.
		/// </summary>
		//-----------------------------------------------------------------------------------------------------------------------
		private static void ClearTiles ()
			{
			//-------------------------------------------------------------------------------------------------------------------
			try
				{
				//---------------------------------------------------------------------------------------------------------------
				Deployment.Current.Dispatcher.BeginInvoke ( () =>
					{
					//-----------------------------------------------------------------------------------------------------------
					foreach ( ShellTile Tile in ShellTile.ActiveTiles )	
						{ ScheduledAgent.ClearTile ( Tile, FlipTileOptions.FromTile ( Tile ) ); }
					//-----------------------------------------------------------------------------------------------------------
					} );
				//---------------------------------------------------------------------------------------------------------------
				}
			//-------------------------------------------------------------------------------------------------------------------
			catch {}
			//-------------------------------------------------------------------------------------------------------------------
			}
		//***********************************************************************************************************************

		//***********************************************************************************************************************
		/// <summary>
		/// Gère l'affichage final de la tuile.
		/// </summary>
		/// <param name="Tile">Tuile à mettre à jour.</param>
		/// <param name="Images">Configuration de la tuile.</param>
		/// <param name="Content">Texte à afficher.</param>
		//-----------------------------------------------------------------------------------------------------------------------
		private static void ClearTile ( ShellTile Tile, FlipTileOptions Images )
			{
			//-------------------------------------------------------------------------------------------------------------------
			ScheduledAgent.UpdateTile ( Tile, Images, string.Empty );
			//-------------------------------------------------------------------------------------------------------------------
			}
		//***********************************************************************************************************************

		//***********************************************************************************************************************
		/// <summary>
		/// Gère l'affichage final de la tuile.
		/// </summary>
		/// <param name="Tile">Tuile à mettre à jour.</param>
		/// <param name="Images">Configuration de la tuile.</param>
		/// <param name="Content">Texte à afficher.</param>
		//-----------------------------------------------------------------------------------------------------------------------
		private static void UpdateTile ( ShellTile Tile, FlipTileOptions Config, string Content )
			{
			//-------------------------------------------------------------------------------------------------------------------
			try { Tile.Update ( GetTileData ( Config, Content ) ); } catch {}
			//-------------------------------------------------------------------------------------------------------------------
			}
		//***********************************************************************************************************************
		
		//-----------------------------------------------------------------------------------------------------------------------
		#endregion
		//***********************************************************************************************************************
		
		//***********************************************************************************************************************
		#region // Section des Procédures de Traitement
		//-----------------------------------------------------------------------------------------------------------------------
		
		//***********************************************************************************************************************
		/// <summary>
		/// Met à jour les tuiles et lance les notifications.
		/// </summary>
		/// <param name="State">Object ontenant les informations à traiter.</param>
		//-----------------------------------------------------------------------------------------------------------------------
		private void OnFinalProcess ( DownloadDataState State )
			{
			//-------------------------------------------------------------------------------------------------------------------
			#region // Implémentation de la Procédure
			//-------------------------------------------------------------------------------------------------------------------
			
			//-------------------------------------------------------------------------------------------------------------------
			Deployment.Current.Dispatcher.BeginInvoke ( () =>
				{
				//---------------------------------------------------------------------------------------------------------------
				State.Items.Sort ( new FlipTileInfosComparer () );
				//---------------------------------------------------------------------------------------------------------------

				//---------------------------------------------------------------------------------------------------------------
				// On a du contenue, on récupère la liste des Tuiles
				//---------------------------------------------------------------------------------------------------------------
				var Tiles = new Dictionary<ShellTile, FlipTileOptions> ();

				if ( ScheduledAgent.TileIsActive )
					foreach ( ShellTile Tile in ShellTile.ActiveTiles )
						{ Tiles[Tile] = FlipTileOptions.FromTile ( Tile ); }
				//---------------------------------------------------------------------------------------------------------------

				//---------------------------------------------------------------------------------------------------------------
				int           ToastCount   = 0;
				FlipTileInfos ToastContent = new FlipTileInfos ();
				//---------------------------------------------------------------------------------------------------------------

				//---------------------------------------------------------------------------------------------------------------
				try
					{
					//-----------------------------------------------------------------------------------------------------------
					// Lecture des Eléments
					//-----------------------------------------------------------------------------------------------------------
					foreach ( FlipTileInfos Item in State.Items )
						{
						//-------------------------------------------------------------------------------------------------------
						var ProcessedTiles = new List <ShellTile> ();

						foreach ( ShellTile Tile in Tiles.Keys )
							{
							FlipTileOptions TileInfos = Tiles[Tile];

							if ( string.IsNullOrEmpty ( TileInfos.Uri ) || Item.Uri.Contains ( TileInfos.Uri ) )
								{
								ScheduledAgent.UpdateTile ( Tile, Tiles[Tile], Item.Title );

								ProcessedTiles.Add ( Tile );
								}
							}

						foreach ( ShellTile Tile in ProcessedTiles ) { Tiles.Remove ( Tile ); }
						//-------------------------------------------------------------------------------------------------------

						//-------------------------------------------------------------------------------------------------------
						// Est ce qu'on check les Toast ?
						//-------------------------------------------------------------------------------------------------------
						if ( State.CheckToast && Item.PublishDate > State.LastToastCheck )
							{
							//---------------------------------------------------------------------------------------------------
							ToastCount ++;
							ToastContent = Item;
							//---------------------------------------------------------------------------------------------------
							}
						//-------------------------------------------------------------------------------------------------------
						}
					//-----------------------------------------------------------------------------------------------------------
					}
				//---------------------------------------------------------------------------------------------------------------
				catch {}
				//---------------------------------------------------------------------------------------------------------------
				finally
					{
					//-----------------------------------------------------------------------------------------------------------
					#region // Un nouvel article
					//-----------------------------------------------------------------------------------------------------------
					if ( ToastCount == 1 )
						{
						//-------------------------------------------------------------------------------------------------------
						State.ToastNotify ();
						//-------------------------------------------------------------------------------------------------------

						//-------------------------------------------------------------------------------------------------------
						string Format      = "ArticleID={0}&LastModified={1}00&IsVideo={2}&Uri={3}";
						string ArticleID   = ToastContent.ArticleID;
						string PublishDate = ToastContent.PublishDate.ToString ( "yyyyMMddHHmm" );
						bool   IsVideo     = ToastContent.IsVideo;
						string Uri         = HttpUtility.UrlEncode ( ToastContent.Link );

						string ToastUri    = string.Format ( Format, ArticleID, PublishDate, IsVideo, Uri );

						(new ShellToast ()
							{
							Title         = "Nouvel article"                                                 ,
							Content       = ToastContent.Title                                               ,
							NavigationUri = new Uri ( "/Frames/Frm_Home.xaml?" + ToastUri, UriKind.Relative ),
							}).Show ();
						//-------------------------------------------------------------------------------------------------------
						}
					//-----------------------------------------------------------------------------------------------------------
					#endregion
					//-----------------------------------------------------------------------------------------------------------

					//-----------------------------------------------------------------------------------------------------------
					#region // Plusieurs nouveaux articles
					//-----------------------------------------------------------------------------------------------------------
					else if ( ToastCount > 1 )
						{
						//-------------------------------------------------------------------------------------------------------
						State.ToastNotify ();
						//-------------------------------------------------------------------------------------------------------

						//-------------------------------------------------------------------------------------------------------
						(new ShellToast ()
							{
							Title         = "01Net Mobile"                                                              ,
							Content       = string.Format ( "tu as {0} nouveaux articles à lire sur 01Net", ToastCount ),
							NavigationUri = new Uri ( "/Frames/Frm_Home.xaml", UriKind.Relative                        ),
							}).Show ();
						//-------------------------------------------------------------------------------------------------------
						}
					//-----------------------------------------------------------------------------------------------------------
					#endregion
					//-----------------------------------------------------------------------------------------------------------
					
					//-----------------------------------------------------------------------------------------------------------
					// On ré-initialise les tuiles non mise à jour
					//-----------------------------------------------------------------------------------------------------------
					foreach ( ShellTile Tile in Tiles.Keys )
						{ ScheduledAgent.ClearTile ( Tile, Tiles[Tile] ); }

					base .NotifyComplete ();
					//-----------------------------------------------------------------------------------------------------------
					}
				//---------------------------------------------------------------------------------------------------------------
				} );
			//-------------------------------------------------------------------------------------------------------------------

			//-------------------------------------------------------------------------------------------------------------------
			#endregion
			//-------------------------------------------------------------------------------------------------------------------
			}
		//***********************************************************************************************************************
		
		//***********************************************************************************************************************
		/// <summary>
		/// Gère la réponse à la récupération des derniers articles.
		/// </summary>
		/// <param name="Sender">Objet source de l'appel.</param>
		/// <param name="Args"><b>...EventArgs</b> qui contient les données d'événement.</param>
		//-----------------------------------------------------------------------------------------------------------------------
		private void OnGetLastArticlesSuccess ( object S, DownloadStringCompletedEventArgs Args )
			{
			//-------------------------------------------------------------------------------------------------------------------
			#region // Implémentation de la Procédure
			//-------------------------------------------------------------------------------------------------------------------

			//-------------------------------------------------------------------------------------------------------------------
			DownloadDataState State = (DownloadDataState)Args.UserState;

			bool CancelNotify = false;
			//-------------------------------------------------------------------------------------------------------------------

			//-------------------------------------------------------------------------------------------------------------------
			try
				{
				//---------------------------------------------------------------------------------------------------------------
				// S'il y a eu une erreur ou une exception, on arrête
				//---------------------------------------------------------------------------------------------------------------
				if ( Args.Cancelled                       ) return;
				if ( Args.Error                   != null ) return;
				if ( string.IsNullOrEmpty ( Args.Result ) ) return;
				//---------------------------------------------------------------------------------------------------------------

				//---------------------------------------------------------------------------------------------------------------
				// A t'on du contenue ?
				//---------------------------------------------------------------------------------------------------------------
				if ( string.IsNullOrEmpty ( Args.Result ) ) return;

				JToken Racine = JToken.Parse ( Args.Result );

				if ( Racine == null || ! Racine.HasValues ) return;
				//---------------------------------------------------------------------------------------------------------------

				//---------------------------------------------------------------------------------------------------------------
				// Ce sont des Articles
				//---------------------------------------------------------------------------------------------------------------
				if ( Racine["articles"] != null )
					{
					//-----------------------------------------------------------------------------------------------------------
					// Lecture des Articles
					//-----------------------------------------------------------------------------------------------------------
					var Items = Racine["articles"].First;

					while ( Items != null )
						{
						//-------------------------------------------------------------------------------------------------------
						string Title = HttpUtility.HtmlDecode ( Items.Value<string>( "title" ) );

						string ArticleID = Items.Value<long  >( "article"  ).ToString ();
						string Link      = Items.Value<string>( "long_url" );

						DateTime Date     = Items.Read<DateTime>( "date"      );
						DateTime EditDate = Items.Read<DateTime>( "edit_date" );

						DateTime PublishDate = ( EditDate > Date ) ? EditDate : Date;

						if ( PublishDate < State.LastAppLaunch ) break;
						//-------------------------------------------------------------------------------------------------------

						//-------------------------------------------------------------------------------------------------------
						State.AddUnique ( new FlipTileInfos ()
							{
							ArticleID   = ArticleID               ,
							Title       = Title                   ,
							PublishDate = PublishDate             ,
							Link        = Link                    ,
							IsVideo     = false                   ,
							Uri         = State.Uri.OriginalString,
							} );
						//-------------------------------------------------------------------------------------------------------
						
						//-------------------------------------------------------------------------------------------------------
						Items = Items.Next;
						//-------------------------------------------------------------------------------------------------------
						}
					//-----------------------------------------------------------------------------------------------------------
					}
				//---------------------------------------------------------------------------------------------------------------

				//---------------------------------------------------------------------------------------------------------------
				// Ce sont des Vidéos
				//---------------------------------------------------------------------------------------------------------------
				else if ( Racine["videos"] != null )
					{
					//-----------------------------------------------------------------------------------------------------------
					// Lecture des Articles
					//-----------------------------------------------------------------------------------------------------------
					var Items = Racine["videos"].First;

					while ( Items != null )
						{
						//-------------------------------------------------------------------------------------------------------
						string Title = HttpUtility.HtmlDecode ( Items.Value<string>( "title" ) );

						string ArticleID = Items.Value<string>( "video"  );
						string Link      = Items.Value<string>( "long_url" );

						DateTime Date     = Items.Read<DateTime>( "begin_date" );
						DateTime EditDate = Items.Read<DateTime>( "end_date"   );

						DateTime PublishDate = ( EditDate > Date ) ? EditDate : Date;

						if ( PublishDate < State.LastAppLaunch ) break;
						//-------------------------------------------------------------------------------------------------------

						//-------------------------------------------------------------------------------------------------------
						State.AddUnique ( new FlipTileInfos ()
							{
							ArticleID   = ArticleID               ,
							Title       = Title                   ,
							PublishDate = PublishDate             ,
							Link        = Link                    ,
							IsVideo     = true                    ,
							Uri         = State.Uri.OriginalString,
							} );
						//-------------------------------------------------------------------------------------------------------
						
						//-------------------------------------------------------------------------------------------------------
						Items = Items.Next;
						//-------------------------------------------------------------------------------------------------------
						}
					//-----------------------------------------------------------------------------------------------------------
					}
				//---------------------------------------------------------------------------------------------------------------

				//---------------------------------------------------------------------------------------------------------------
				CancelNotify = true;
				//---------------------------------------------------------------------------------------------------------------
				}
			//-------------------------------------------------------------------------------------------------------------------
			catch {}
			//-------------------------------------------------------------------------------------------------------------------
			finally
				{
				//---------------------------------------------------------------------------------------------------------------
				State.Notify ();

				if ( ! CancelNotify ) base.NotifyComplete (       );
				else                  this.AsyncCallUri   ( State );
				//---------------------------------------------------------------------------------------------------------------
				}
			//-------------------------------------------------------------------------------------------------------------------

			//-------------------------------------------------------------------------------------------------------------------
			#endregion
			//-------------------------------------------------------------------------------------------------------------------
			}
		//***********************************************************************************************************************
		
		//***********************************************************************************************************************
		/// <summary>
		/// Récupère les derniers articles publiés.
		/// </summary>
		/// <returns><b>True</b> si le traitement est en cours, sinon <b>False</b>.</returns>
		//-----------------------------------------------------------------------------------------------------------------------
		private bool AsyncCallUri ( DownloadDataState State )
			{
			//-------------------------------------------------------------------------------------------------------------------
			#region // Implémentation de la Procédure
			//-------------------------------------------------------------------------------------------------------------------

			//-------------------------------------------------------------------------------------------------------------------
			try
				{
				//---------------------------------------------------------------------------------------------------------------
				Uri Uri = State.Uri;

				if ( Uri != null )
					{
					//-----------------------------------------------------------------------------------------------------------
					var WebClient = new WebClient ();

					WebClient.Headers["User-Agent"] = UserAgent;

					WebClient.DownloadStringCompleted += this.OnGetLastArticlesSuccess;

					WebClient.DownloadStringAsync ( Uri, State );
					//-----------------------------------------------------------------------------------------------------------
					}
				//---------------------------------------------------------------------------------------------------------------

				//---------------------------------------------------------------------------------------------------------------
				else { this.OnFinalProcess ( State ); }
				//---------------------------------------------------------------------------------------------------------------
				}
			//-------------------------------------------------------------------------------------------------------------------
			catch { return false; }
			//-------------------------------------------------------------------------------------------------------------------

			//-------------------------------------------------------------------------------------------------------------------
			return true;
			//-------------------------------------------------------------------------------------------------------------------

			//-------------------------------------------------------------------------------------------------------------------
			#endregion
			//-------------------------------------------------------------------------------------------------------------------
			}
		//***********************************************************************************************************************
		
		//***********************************************************************************************************************
		/// <summary>
		/// Gère la réponse à l'enregistrement.
		/// </summary>
		/// <param name="S">...</param>
		/// <param name="Args">...</param>
		//-----------------------------------------------------------------------------------------------------------------------
		private void OnRegistationSuccess ( object S, DownloadStringCompletedEventArgs Args )
			{
			//-------------------------------------------------------------------------------------------------------------------
			#region // Implémentation de la Procédure
			//-------------------------------------------------------------------------------------------------------------------

			//-------------------------------------------------------------------------------------------------------------------
			DownloadDataState State = (DownloadDataState)Args.UserState;

			bool CancelNotify = false;
			//-------------------------------------------------------------------------------------------------------------------

			//-------------------------------------------------------------------------------------------------------------------
			try
				{
				//---------------------------------------------------------------------------------------------------------------
				if ( string.IsNullOrEmpty ( Args.Result ) ) return;

				JToken Racine = JToken.Parse ( Args.Result );

				if ( Racine == null || ! Racine.HasValues ) return;

				JToken Session = Racine["session"];

				if ( Session == null || ! Session.HasValues ) return;

				State.SetToken ( Session.Value<string>( "token" ) );

				CancelNotify = this.AsyncCallUri ( State );
				//---------------------------------------------------------------------------------------------------------------
				}
			//-------------------------------------------------------------------------------------------------------------------
			catch {}
			//-------------------------------------------------------------------------------------------------------------------
			finally { if ( ! CancelNotify ) base.NotifyComplete (); }
			//-------------------------------------------------------------------------------------------------------------------

			//-------------------------------------------------------------------------------------------------------------------
			#endregion
			//-------------------------------------------------------------------------------------------------------------------
			}
		//***********************************************************************************************************************

		//***********************************************************************************************************************
		/// <summary>
		/// Enregistre l'agent au près du service.
		/// </summary>
		/// <returns>
		/// <b>True</b> si aucune anomalie n'est apparu lors de l'appel, sinon <b>False</b>.
		/// </returns>
		//-----------------------------------------------------------------------------------------------------------------------
		private bool AsyncRegisterApp ( DownloadDataState State )
			{
			//-------------------------------------------------------------------------------------------------------------------
			#region // Implémentation de la Procédure
			//-------------------------------------------------------------------------------------------------------------------

			//-------------------------------------------------------------------------------------------------------------------
			try
				{
				//---------------------------------------------------------------------------------------------------------------
				string Uri = "https://api.nextradiotv.com/01net-ipad/3.3/";

				var WebClient = new WebClient ();

				WebClient.Headers["User-Agent"] = UserAgent;

				WebClient.DownloadStringCompleted += this.OnRegistationSuccess;

				WebClient.DownloadStringAsync ( new Uri ( Uri ), State );
				//---------------------------------------------------------------------------------------------------------------
				}
			//-------------------------------------------------------------------------------------------------------------------
			catch { return false; }
			//-------------------------------------------------------------------------------------------------------------------

			//-------------------------------------------------------------------------------------------------------------------
			return true;
			//-------------------------------------------------------------------------------------------------------------------

			//-------------------------------------------------------------------------------------------------------------------
			#endregion
			//-------------------------------------------------------------------------------------------------------------------
			}
		//***********************************************************************************************************************

		//***********************************************************************************************************************
		/// <summary>
		/// Agent qui exécute une tâche planifiée.
		/// </summary>
		/// <param name="task">La tâche appelée.</param>
		//-----------------------------------------------------------------------------------------------------------------------
		protected override void OnInvoke ( ScheduledTask task )
			{
			//-------------------------------------------------------------------------------------------------------------------
			#region // Implémentation de la Procédure
			//-------------------------------------------------------------------------------------------------------------------

			//-------------------------------------------------------------------------------------------------------------------
			bool CancelNotify = false;
			//-------------------------------------------------------------------------------------------------------------------

			//-------------------------------------------------------------------------------------------------------------------
			try
				{
				//---------------------------------------------------------------------------------------------------------------
				if ( ! TileIsActive && ToastDelay == 0           ) return;
				if ( ! NetworkInterface.GetIsNetworkAvailable () ) return;

				CancelNotify = this.AsyncRegisterApp ( new DownloadDataState () );
				//---------------------------------------------------------------------------------------------------------------
				}
			//-------------------------------------------------------------------------------------------------------------------
			catch {}
			//-------------------------------------------------------------------------------------------------------------------
			finally
				{
				//---------------------------------------------------------------------------------------------------------------
				if ( ! CancelNotify )
					{
					//-----------------------------------------------------------------------------------------------------------
					base.NotifyComplete       ();
					ScheduledAgent.ClearTiles ();
					//-----------------------------------------------------------------------------------------------------------
					}
				//---------------------------------------------------------------------------------------------------------------
				}
			//-------------------------------------------------------------------------------------------------------------------

			//-------------------------------------------------------------------------------------------------------------------
			#endregion
			//-------------------------------------------------------------------------------------------------------------------
			}
		//***********************************************************************************************************************
		
		//-----------------------------------------------------------------------------------------------------------------------
		#endregion
		//***********************************************************************************************************************

		//***********************************************************************************************************************
		#region // PROCEDURE >> Clear
		//-----------------------------------------------------------------------------------------------------------------------
		/// <summary>
		/// Purge la tuile.
		/// </summary>
		//-----------------------------------------------------------------------------------------------------------------------
		public static void Clear ()
			{
			//-------------------------------------------------------------------------------------------------------------------
			StorageSettings.SetValue ( "agent-last-app-launch" , DateTime.Now                    );
			StorageSettings.SetValue ( "agent-last-toast-check", DateTime.Now.AddMinutes ( -30 ) );
			
			ScheduledAgent.ClearTiles ();
			//-------------------------------------------------------------------------------------------------------------------
			}
		//-----------------------------------------------------------------------------------------------------------------------
		#endregion
		//***********************************************************************************************************************
		
		//***********************************************************************************************************************
		#region // PROCEDURE >> GetTileData
		//-----------------------------------------------------------------------------------------------------------------------
		/// <summary>
		/// Obtiens les infos nécessaires à la création de la tuile.
		/// </summary>
		//-----------------------------------------------------------------------------------------------------------------------
		public static FlipTileData GetTileData ( Uri Uri )
			{
			//-------------------------------------------------------------------------------------------------------------------
			var TileConfig = FlipTileOptions.FromUri ( Uri );
				
			return ScheduledAgent.GetTileData ( TileConfig, string.Empty );
			//-------------------------------------------------------------------------------------------------------------------
			}
		//-----------------------------------------------------------------------------------------------------------------------
		#endregion
		//***********************************************************************************************************************

		//***********************************************************************************************************************
		#region // PROPERTY >> TileIsActive
		//-----------------------------------------------------------------------------------------------------------------------
		/// <summary>
		/// Indique si la tuile dynamique est active.
		/// </summary>
		//-----------------------------------------------------------------------------------------------------------------------
		public static bool TileIsActive
			{
			//-------------------------------------------------------------------------------------------------------------------
			get { return (bool)StorageSettings.GetValue ( "agent-tile-is-active", false ); }
			set {              StorageSettings.SetValue ( "agent-tile-is-active", value ); }
			//-------------------------------------------------------------------------------------------------------------------
			}
		//-----------------------------------------------------------------------------------------------------------------------
		#endregion
		//***********************************************************************************************************************

		//***********************************************************************************************************************
		#region // PROPERTY >> ToastDelay
		//-----------------------------------------------------------------------------------------------------------------------
		/// <summary>
		/// Indique si les notifications sont actives.
		/// </summary>
		//-----------------------------------------------------------------------------------------------------------------------
		public static int ToastDelay
			{
			//-------------------------------------------------------------------------------------------------------------------
			get
				{
				object Value = StorageSettings.GetValue ( "agent-toast-delay" );

				if ( Value == null )
					{
					bool Active = StorageSettings.GetValue ( "agent-toast-is-active", false );

					Value = ( Active ) ? (int)1 : (int)0;

					StorageSettings.SetValue ( "agent-toast-delay", (int)Value );
					}
				
				return (int)Value;
				}
			//-------------------------------------------------------------------------------------------------------------------
			set
				{
				//---------------------------------------------------------------------------------------------------------------
				switch ( value )
					{
					case 1  : StorageSettings.SetValue ( "agent-toast-delay", value ); break;
					case 2  : StorageSettings.SetValue ( "agent-toast-delay", value ); break;
					case 6  : StorageSettings.SetValue ( "agent-toast-delay", value ); break;
					default : StorageSettings.SetValue ( "agent-toast-delay", 0     ); break;
					}
				//---------------------------------------------------------------------------------------------------------------
				}
			//-------------------------------------------------------------------------------------------------------------------
			}
		//-----------------------------------------------------------------------------------------------------------------------
		#endregion
		//***********************************************************************************************************************
		}
	//---------------------------------------------------------------------------------------------------------------------------
	#endregion
	//***************************************************************************************************************************

	} // Fin du namespace "NextRadio.Scheduler"
//*******************************************************************************************************************************

//*******************************************************************************************************************************
// FIN DU FICHIER
//*******************************************************************************************************************************
